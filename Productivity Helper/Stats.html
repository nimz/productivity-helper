<!DOCTYPE html>
<html>
<head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script id="varDefs" src="Statistics.js"></script>
</head>
<body>

<h1>Productivity Statistics</h1>

<div>(as of <span id="time"></span>)</div>

<p>Time Wasted Today: </p>

<p>Total Time Wasted: </p>

<p>From: <input type="text" id="from" value="mm/dd/yy" onclick="clearInput(0)" onchange="validateDate(0)" />
   To:   <input type="text" id="to"   value="mm/dd/yy" onclick="clearInput(1)" onchange="validateDate(1)" /></p>

</body>
<script type="text/javascript">
var cleared = [false, false];
function clearInput(i) {
  if (cleared[i]) return;
  cleared[i] = true;
  if (i == 0) d3.select("#from").attr("value", "");
  else d3.select("#to").attr("value", "");
}

function validateDate(i) {
  var datestr;
  if (i == 0) datestr = d3.select("#from").property("value");
  else datestr = d3.select("#to").property("value");
  datestr = datestr.trim();
  var vals = datestr.split("/");
  if (vals.length != 3) {
    alert("Please enter a valid date.");
    return;
  }
}

// found on http://stackoverflow.com/questions/4522213/can-someone-explain-this-javascript-real-time-clock-to-me
function checkTime(i) {
  return (i < 10) ? "0" + i : i;
}

function startTime() {
  var today = new Date(),
      h = checkTime(today.getHours()),
      m = checkTime(today.getMinutes()),
      s = checkTime(today.getSeconds());
  document.getElementById('time').innerHTML = h + ":" + m + ":" + s;
  t = setTimeout(function () {
      startTime()
  }, 250);
}
startTime();

var re = new RegExp('(?<!\\\\),');
var fulldata;
d3.text("Statistics.txt", function(d) {
  var lines = d.split("\n");
  var index = 0; // skip first line
  var firstSess = true;
  var sessions = [], curSessData = [];
  var curSessDict = {};
  var curStart, curEnd;
  while (index++ < lines.length - 2) { // skip last line (newline)
    var line = lines[index];
    var splitLine = line.split(" ");
    var firstWord = splitLine[0];
    if (firstWord === "Session") {
      if (firstSess) {
        firstSess = false;
      }
      else {
        sessions.push(curSessData);
      }
      curSessData = [];
      var sessInfo = line.split(",");
      curSessData.push(sessInfo[0].substring(8));
      curSessData.push(sessInfo[1]);
    }
    else if (firstWord === "Started") {
      curStart = Date.parse(splitLine[2] + splitLine[3]);
    }
    else if (firstWord === "Stopped") {
      curEnd = Date.parse(splitLine[2] + splitLine[3]);
    }
    else {
      var activity = line.split(re);
      var firstActWord = activity[0].split(" ")[0];
      var actType;
      if (firstActWord === "Task:") {
        actType = 0;
      }
      else if (firstActWord === "Break") {
        actType = 1;
      }
      else actType = 2;
      var startTime = Date.parse(activity[1]), endTime = Date.parse(activity[2]);
      var duration = (endTime - startTime)/1000;
      activity.push(actType);
      activity.push(duration);
      curSessData.push(activity);
    }
  }
  sessions.push(curSessData);
  fulldata = sessions;
  return d;
});
</script>
</html>
